<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-inherit="mrp.BomOverviewLine"
       t-inherit-mode="extension"
       t-name="cr_mrp_bom_customisation.BomOverviewLineBranch">


        <xpath expr="//td[@name='td_mrp_bom']" position="before">
             <td class="text-center" style="width: 50px;">
                <t t-if="data.product_id">
                     <img t-att-src="'/web/image/product.product/' + data.product_id + '/image_128'"
                          style="max-height:32px; max-width:32px; border-radius: 4px; cursor: pointer;"
                          t-att-alt="data.product_name"
                          t-att-title="'Click to enlarge ' + data.product_name"
                          t-on-click="() => this.openImageModal(data.product_id, data.name || data.product_name || data.display_name)"
                          onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"/>

                    <span class="text-muted" style="display:none;">No Img</span>
                </t>
                 <t t-else="">
                    <span class="text-muted">No Img</span>
                </t>
            </td>

             <td t-if="props.showOptions.defaultCode" class="text-center">
        <span t-if="data.default_code" t-esc="data.default_code"/>
                 <span t-else="" class="text-muted"></span>
    </td>
             <td t-if="props.showOptions.oldEverestPn" class="text-center">
        <span t-if="data.old_everest_pn" t-esc="data.old_everest_pn"/>
                 <span t-else="" class="text-muted"></span>
    </td>

             <td t-if="data.is_evr and props.showOptions.moInternalRef" class="text-center">

                    <select t-if="data.product_manufacturer_editable"
                            class="form-select form-select-sm"
                            t-att-data-bom-line-id="data.bom_line_id"
                            t-model="data.product_manufacturer_id"
                            t-on-change="onProductManufacturerChange">

                        <option value="">Select Manufacturer Ref</option>
                        <t t-foreach="data.available_manufacturers" t-as="mref" t-key="mref.id">
                            <option t-att-value="mref.id">
                                <t t-esc="mref.ref"/>
                            </option>
                        </t>
                    </select>
                 <span t-else="" class="text-muted"></span>
                </td>
         </xpath>


        <xpath expr="//td[@name='td_mrp_bom']" position="after">
                 <td t-if="data.is_evr and props.showOptions.approveToManufacture" class="text-center">
                    <input t-if="data.approve_to_manufacture_editable"
                           type="checkbox"
                           class="form-check-input"
                           t-model="data.approve_to_manufacture"
                           t-att-data-bom-line-id="data.bom_line_id"
                           t-on-change="onApproveToManufactureChange"/>
                     <span t-elif="data.approve_to_manufacture"
                           class="badge badge-success bg-success text-white">✓</span>
                     <span t-else="" class="text-muted"></span>
                </td>
        </xpath>


        <xpath expr="//td[@t-if='showAvailabilities'][1]" position="before">
            <td t-if="data.is_evr and props.showOptions.cfeQuantity" class="text-center cfe_data">
                    <input t-if="data.cfe_editable"
                           type="text"
                           class="form-control form-control-sm cfe-quantity-input"
                           t-att-data-bom-line-id="data.bom_line_id"
                           t-model="data.cfe_quantity"
                           placeholder="CFE Qty"
                           style="width: 80px; margin: 0 auto;"
                           t-on-blur="onCfeQuantityChange"/>
                <span t-elif="data.has_cfe_quantity"
                      class="badge badge-info bg-info text-white">
                        CFE: <t t-esc="data.cfe_quantity"/>
                    </span>
                <span t-else="" class="text-muted"></span>
            </td>

            <td t-if="data.is_evr" class="text-center">
                <t t-if="data.branch">
                    <span t-esc="data.branch"/>
                </t>
                <t t-else="">
                    <span class="text-muted"></span>
                </t>
            </td>

            <td t-if="data.is_evr and props.showOptions.approval1" class="text-center">
                <input t-if="data.approval_1_editable"
                       type="checkbox"
                       class="form-check-input"
                       t-model="data.approval_1"
                       t-att-data-bom-line-id="data.bom_line_id"
                       t-on-change="onApproval1Change"/>
                <span t-elif="data.approval_1"
                      class="badge badge-success bg-success text-white">
                      ✓ App1
                </span>
                <span t-else="" class="text-muted"></span>
            </td>

            <td t-if="data.is_evr and props.showOptions.approval2" class="text-center">
                <input t-if="data.approval_2_editable and data.can_edit_approval_2"
                       type="checkbox"
                       class="form-check-input"
                       t-model="data.approval_2"
                       t-att-data-bom-line-id="data.bom_line_id"
                       t-on-change="onApproval2Change"/>
                <input t-elif="data.approval_2_editable and !data.can_edit_approval_2"
                       type="checkbox"
                       class="form-check-input"
                       t-model="data.approval_2"
                       t-att-data-bom-line-id="data.bom_line_id"
                       disabled="1"
                       title="Only Manufacturing/Admin or Purchase/Admin can edit this field"/>
                <span t-else="" class="text-muted"></span>
            </td>


            <td t-if="data.is_evr and props.showOptions.customerRef" class="text-center">
                <input t-if="data.customer_ref_editable"
                       type="text"
                       class="form-control form-control-sm"
                       t-att-data-bom-line-id="data.bom_line_id"
                       t-model="data.customer_ref"
                       placeholder="Customer Ref"
                       style="width: 120px; margin: 0 auto;"
                       t-on-blur="onCustomerRefChange"/>
                <span t-elif="data.customer_ref" t-esc="data.customer_ref"/>
                <span t-else="" class="text-muted"></span>
            </td>


            <td t-if="data.is_evr and props.showOptions.poLineId" class="text-center">
                <t t-if="data.po_data and data.po_data.length > 0">
                    <t t-foreach="data.po_data" t-as="po" t-key="po.id">
                        <span class="text-primary"
                              t-on-click="(ev) => this.onPoClick(po.id)"
                              style="cursor: pointer; text-decoration: none;"
                              t-esc="po.name"/>
                        <t t-if="!po_last">, </t>
                    </t>
                </t>
                <span t-else="" class="text-muted"></span>
            </td>

            <t t-if="data.is_evr and props.showOptions.purchaseGroup">
                <td class="text-center">
                    <t t-if="data.purchase_group_editable">
                        <span t-esc="data.to_order"/>
                    </t>
                    <t t-else="">

                    </t>
                </td>
                <td class="text-center">
                    <t t-if="data.purchase_group_editable">
                       <span t-esc="data.to_order_cfe"/>
                    </t>
                    <t t-else="">

                    </t>

                </td>
                <td class="text-center">
                      <t t-if="data.purchase_group_editable">
                       <span t-esc="data.ordered"/>
                    </t>
                    <t t-else="">

                    </t>
                </td>
                <td class="text-center">
                    <t t-if="data.purchase_group_editable">
                       <span t-esc="data.ordered_cfe"/>
                    </t>
                    <t t-else="">

                    </t>
                </td>
                <td class="text-center">
                    <t t-if="data.purchase_group_editable">
                       <span t-esc="data.to_transfer"/>
                    </t>
                    <t t-else="">

                    </t>

                </td>
                <td class="text-center">
                     <t t-if="data.purchase_group_editable">
                       <span t-esc="data.to_transfer_cfe"/>
                    </t>
                    <t t-else="">

                    </t>
                </td>
                <td class="text-center">
                      <t t-if="data.purchase_group_editable">
                    <span t-esc="data.transferred"/>
                    </t>
                    <t t-elif="data.transferred_editable">
                         <span t-esc="data.transferred"/>
                     </t>
                    <t t-else="">

                    </t>
                </td>
                <td class="text-center">
                    <t t-if="data.purchase_group_editable">
                    <span t-esc="data.transferred_cfe"/>
                    </t>
                    <t t-else="">

                    </t>
                </td>
                <td class="text-center" name="td_used">
                     <t t-if="data.purchase_group_editable">
                    <span t-esc="data.used"/>
                    </t>
                    <t t-elif="data.used_editable">
                         <span t-esc="data.used"/>
                     </t>
                    <t t-else="">

                    </t>
                </td>
            </t>

            <td t-if="data.is_evr and props.showOptions.freeToUse" class="text-center">
                  <t t-if="data.display_free_to_use">
                       <span t-esc="data.free_to_use"/>
                  </t>
                <t t-else=""/>

            </td>

        </xpath>


        <!-- Display Cost Fields - Replace existing cost columns -->
        <xpath expr="//td[@t-if='showCosts'][1]" position="replace">
            <td t-if="props.showOptions.displayCost"
                t-attf-class="text-end {{ data.type == 'component' ? 'opacity-50' : '' }}"
                t-esc="formatMonetary(data.bom_cost)"/>
        </xpath>

        <xpath expr="//td[@t-if='showCosts'][1]" position="replace">
            <td t-if="props.showOptions.displayCost" class="text-end">
                <span t-if="data.hasOwnProperty('prod_cost')" t-esc="formatMonetary(data.prod_cost)"/>
            </td>
        </xpath>

    </t>
</templates>